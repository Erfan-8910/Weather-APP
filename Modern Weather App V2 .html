<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Modern Weather App</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <style>
        :root {
            /* تنظیمات پیش‌فرض (حالت شب) */
            --text-color: #ffffff;
            --text-secondary: rgba(255, 255, 255, 0.7);
            --glass-bg: rgba(20, 20, 20, 0.3); 
            --glass-border: rgba(255, 255, 255, 0.15);
            --card-radius: 24px;
            --icon-filter: drop-shadow(0 0 15px rgba(255,255,255,0.4));
            --bar-bg: rgba(255,255,255,0.1);
            --bar-fill: rgba(255,255,255,0.9);
        }

        /* --- تنظیمات حالت روز (Day Mode) --- */
        body.is-day {
            --text-color: #1a2a3a; /* سرمه‌ای تیره */
            --text-secondary: rgba(26, 42, 58, 0.7);
            --glass-bg: rgba(255, 255, 255, 0.4); /* شیشه روشن */
            --glass-border: rgba(255, 255, 255, 0.6);
            --icon-filter: drop-shadow(0 0 10px rgba(0,0,0,0.2));
            --bar-bg: rgba(0,0,0,0.1);
            --bar-fill: #2980b9;
        }

        * { margin: 0; padding: 0; box-sizing: border-box; -webkit-tap-highlight-color: transparent; }

        body {
            font-family: -apple-system, BlinkMacSystemFont, "SF Pro Display", "Segoe UI", Roboto, sans-serif;
            background: #000;
            color: var(--text-color);
            min-height: 100vh;
            overflow-x: hidden;
            position: relative;
            transition: color 0.5s ease;
        }

        /* --- Dynamic Animated Gradient Background --- */
        #bg-gradient {
            position: fixed; top: -10%; left: -10%; width: 120%; height: 120%;
            z-index: -10;
            /* گرادینت پیش‌فرض (شب) */
            background: linear-gradient(135deg, #0f2027, #203a43, #2c5364);
            background-size: 400% 400%;
            animation: gradientFlow 15s ease infinite;
            transition: background 1.5s ease;
        }

        /* گرادینت روز */
        body.is-day #bg-gradient {
            background: linear-gradient(135deg, #89f7fe, #66a6ff);
        }

        /* گرادینت روز ابری/بارانی (تیره تر) */
        body.is-day.stormy #bg-gradient {
            background: linear-gradient(135deg, #485563, #29323c);
            --text-color: #ffffff; /* برگرداندن متن به سفید در روز طوفانی */
        }

        @keyframes gradientFlow {
            0% { background-position: 0% 50%; }
            50% { background-position: 100% 50%; }
            100% { background-position: 0% 50%; }
        }

        #weatherCanvas {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            pointer-events: none; z-index: -5;
        }

        /* --- Layout --- */
        .app-container {
            width: 100%; max-width: 600px; 
            margin: 0 auto; padding: 20px;
            display: flex; flex-direction: column; min-height: 100vh;
            position: relative; z-index: 10;
        }

        .header {
            display: flex; justify-content: space-between; align-items: center;
            padding-bottom: 20px; margin-top: 10px;
        }
        .city-name { font-size: 1.8rem; font-weight: 700; text-shadow: 0 4px 15px rgba(0,0,0,0.1); }
        .date-str { font-size: 0.9rem; color: var(--text-secondary); margin-top: 2px; }

        .btn-circle {
            width: 44px; height: 44px; border-radius: 50%;
            background: var(--glass-bg); border: 1px solid var(--glass-border);
            color: var(--text-color); display: flex; justify-content: center; align-items: center;
            cursor: pointer; backdrop-filter: blur(10px); transition: 0.3s;
        }
        .btn-circle:hover { transform: scale(1.05); }

        .glass-card {
            background: var(--glass-bg);
            border: 1px solid var(--glass-border);
            border-radius: var(--card-radius);
            backdrop-filter: blur(30px); -webkit-backdrop-filter: blur(30px);
            padding: 20px; margin-bottom: 15px;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.1);
            transition: all 0.5s ease;
        }

        .hero {
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            padding: 30px 20px; text-align: center; min-height: 220px;
        }
        .hero-icon { 
            font-size: 4.5rem; margin-bottom: 10px; 
            filter: var(--icon-filter);
            transition: filter 0.5s ease;
        }
        .hero-temp { font-size: 5.5rem; font-weight: 200; line-height: 1; letter-spacing: -3px; }
        .hero-desc { font-size: 1.4rem; margin: 10px 0; font-weight: 500; text-transform: capitalize; }
        .hero-hl { color: var(--text-secondary); }

        .hourly-scroll { display: flex; overflow-x: auto; gap: 20px; padding-bottom: 5px; }
        .hourly-scroll::-webkit-scrollbar { display: none; }
        .h-item { display: flex; flex-direction: column; align-items: center; gap: 8px; min-width: 55px; }

        .day-row {
            display: flex; align-items: center; justify-content: space-between;
            padding: 12px 0; border-bottom: 1px solid var(--glass-border);
        }
        .day-row:last-child { border-bottom: none; }
        .temp-bar-bg { width: 80px; height: 4px; background: var(--bar-bg); border-radius: 2px; position: relative; }
        .temp-bar-fill { position: absolute; height: 100%; background: var(--bar-fill); border-radius: 2px; }

        .details-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 30px; }
        .d-item {
            background: var(--glass-bg); border-radius: 20px; padding: 15px;
            display: flex; flex-direction: column; gap: 5px; border: 1px solid var(--glass-border);
        }
        .d-label { font-size: 0.7rem; text-transform: uppercase; color: var(--text-secondary); }
        .d-val { font-size: 1.4rem; font-weight: 600; }

        .search-ui {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.9); backdrop-filter: blur(20px);
            z-index: 1000; display: flex; flex-direction: column; align-items: center; padding-top: 100px;
            opacity: 0; pointer-events: none; transition: 0.3s;
        }
        .search-ui.active { opacity: 1; pointer-events: auto; }
        .search-inp {
            background: transparent; border: none; border-bottom: 2px solid rgba(255,255,255,0.5);
            width: 80%; font-size: 1.5rem; color: #fff; text-align: center; padding: 10px; outline: none;
        }

        .footer { text-align: center; padding-bottom: 20px; }
        .github-link {
            display: inline-flex; align-items: center; gap: 8px;
            background: var(--glass-bg); padding: 8px 16px; border-radius: 20px;
            color: var(--text-color); text-decoration: none; font-size: 0.8rem;
            border: 1px solid var(--glass-border);
        }

        #loader { position: fixed; top:50%; left:50%; transform:translate(-50%, -50%); display:none; font-weight: 500; color: #fff;}
    </style>
</head>
<body>

    <div id="bg-gradient"></div>
    <canvas id="weatherCanvas"></canvas>

    <div class="search-ui" id="searchUI">
        <h2 style="margin-bottom:30px; font-weight:400; color:#fff">Find City</h2>
        <input type="text" class="search-inp" id="cityInput" placeholder="Enter name..." autocomplete="off">
        <i class="fas fa-times" onclick="toggleSearch(false)" style="font-size:2rem; margin-top:40px; cursor:pointer; opacity:0.6; color:#fff"></i>
    </div>

    <div id="loader">Fetching Weather...</div>

    <div class="app-container">
        <div class="header">
            <div>
                <div class="city-name" id="uiCity">---</div>
                <div class="date-str" id="uiDate">---</div>
            </div>
            <div style="display:flex; gap:10px;">
                <div class="btn-circle" onclick="getGPS()"><i class="fas fa-location-arrow"></i></div>
                <div class="btn-circle" onclick="toggleSearch(true)"><i class="fas fa-search"></i></div>
            </div>
        </div>

        <div id="mainContent" style="display:none; animation: fadeIn 0.8s ease;">
            
            <div class="glass-card hero">
                <i class="fas fa-cloud hero-icon" id="uiIcon"></i>
                <div class="hero-temp" id="uiTemp">--</div>
                <div class="hero-desc" id="uiDesc">---</div>
                <div class="hero-hl">H:<span id="uiHigh">--</span>° L:<span id="uiLow">--</span>°</div>
            </div>

            <div class="glass-card">
                <div class="d-label" style="margin-bottom:15px;"><i class="far fa-clock"></i> 24-HOUR FORECAST</div>
                <div class="hourly-scroll" id="hourlyList"></div>
            </div>

            <div class="glass-card">
                <div class="d-label" style="margin-bottom:15px;"><i class="far fa-calendar-alt"></i> 7-DAY FORECAST</div>
                <div id="dailyList"></div>
            </div>

            <div class="details-grid">
                <div class="d-item">
                    <span class="d-label"><i class="fas fa-wind"></i> WIND</span>
                    <span class="d-val"><span id="uiWind">--</span> <small style="font-size:0.8rem">km/h</small></span>
                </div>
                <div class="d-item">
                    <span class="d-label"><i class="fas fa-tint"></i> HUMIDITY</span>
                    <span class="d-val"><span id="uiHumid">--</span>%</span>
                </div>
                <div class="d-item">
                    <span class="d-label"><i class="fas fa-thermometer-half"></i> FEELS LIKE</span>
                    <span class="d-val" id="uiFeels">--°</span>
                </div>
                <div class="d-item">
                    <span class="d-label"><i class="fas fa-tachometer-alt"></i> PRESSURE</span>
                    <span class="d-val"><span id="uiPres">--</span> <small style="font-size:0.8rem">hPa</small></span>
                </div>
            </div>

            <div class="footer">
                <a href="https://github.com/Erfan-8910/Weather-APP" target="_blank" class="github-link">
                    <i class="fab fa-github"></i> Erfan-8910
                </a>
            </div>
        </div>
    </div>

    <script>
        // --- Canvas Engine ---
        const canvas = document.getElementById('weatherCanvas');
        const ctx = canvas.getContext('2d');
        let width, height;
        let particles = [];
        let weatherType = 'clear';
        let windSpeed = 0;
        let isDayGlobal = false; // متغیر سراسری برای تشخیص روز/شب در انیمیشن

        function resizeCanvas() {
            width = canvas.width = window.innerWidth;
            height = canvas.height = window.innerHeight;
        }
        window.addEventListener('resize', resizeCanvas);
        resizeCanvas();

        class Particle {
            constructor(type) {
                this.type = type;
                this.reset();
            }
            reset() {
                this.x = Math.random() * width;
                this.y = Math.random() * -height;
                this.z = Math.random() * 0.5 + 0.5;
                
                if (this.type === 'rain') {
                    this.vy = (Math.random() * 10 + 10) * this.z;
                    this.len = (Math.random() * 10 + 10) * this.z;
                } else if (this.type === 'snow') {
                    this.vy = (Math.random() * 2 + 1) * this.z;
                    this.radius = (Math.random() * 2 + 1) * this.z;
                }
            }
            update() {
                this.y += this.vy;
                this.x += (windSpeed / 10) * this.z;
                if (this.y > height) { this.reset(); this.y = -10; }
                if (this.x > width) this.x = 0;
                if (this.x < 0) this.x = width;
            }
            draw() {
                ctx.globalAlpha = this.z * 0.6;
                // رنگ ذرات: اگر روز بود، آبی/خاکستری تیره؛ اگر شب بود، سفید
                const color = isDayGlobal ? '#3b5f75' : '#ffffff'; 
                ctx.fillStyle = color;
                ctx.strokeStyle = color;

                if (this.type === 'rain') {
                    ctx.beginPath();
                    ctx.lineWidth = 1.5 * this.z;
                    ctx.moveTo(this.x, this.y);
                    ctx.lineTo(this.x + (windSpeed/5), this.y + this.len);
                    ctx.stroke();
                } else if (this.type === 'snow') {
                    ctx.beginPath();
                    ctx.arc(this.x, this.y, this.radius, 0, Math.PI * 2);
                    ctx.fill();
                }
            }
        }

        function initParticles(type, count) {
            weatherType = type;
            particles = [];
            if (type === 'clear') return;
            for(let i=0; i<count; i++) particles.push(new Particle(type));
        }

        function animate() {
            ctx.clearRect(0, 0, width, height);
            if (weatherType !== 'clear') {
                for (let p of particles) { p.update(); p.draw(); }
            }
            requestAnimationFrame(animate);
        }
        animate();

        // --- Logic ---
        const weatherCodes = {
            0: { l: 'Clear', i: 'fa-sun', type: 'clear' },
            1: { l: 'Mainly Clear', i: 'fa-sun', type: 'clear' },
            2: { l: 'Partly Cloudy', i: 'fa-cloud-sun', type: 'clear' },
            3: { l: 'Overcast', i: 'fa-cloud', type: 'clear' }, 
            45: { l: 'Fog', i: 'fa-smog', type: 'clear' },
            51: { l: 'Drizzle', i: 'fa-cloud-rain', type: 'rain', count: 50 },
            61: { l: 'Rain', i: 'fa-cloud-showers-heavy', type: 'rain', count: 100 },
            63: { l: 'Heavy Rain', i: 'fa-cloud-showers-heavy', type: 'rain', count: 200 },
            71: { l: 'Snow', i: 'fa-snowflake', type: 'snow', count: 80 },
            95: { l: 'Storm', i: 'fa-bolt', type: 'rain', count: 300 }
        };

        // Parallax
        document.addEventListener('mousemove', (e) => {
            const x = (e.clientX / width - 0.5) * 20;
            const y = (e.clientY / height - 0.5) * 20;
            document.getElementById('bg-gradient').style.transform = `translate(${x}px, ${y}px)`;
        });

        window.onload = () => {
            const saved = localStorage.getItem('proCityFix');
            if(saved) fetchCity(saved); else toggleSearch(true);
        }

        function toggleSearch(show) {
            const el = document.getElementById('searchUI');
            if(show) { el.classList.add('active'); document.getElementById('cityInput').focus(); }
            else el.classList.remove('active');
        }

        document.getElementById('cityInput').addEventListener('keypress', (e) => {
            if(e.key==='Enter' && e.target.value) { fetchCity(e.target.value); toggleSearch(false); e.target.value=''; }
        });

        function getGPS() {
            if(navigator.geolocation) {
                document.getElementById('loader').style.display='block';
                navigator.geolocation.getCurrentPosition(pos => {
                    fetchData(pos.coords.latitude, pos.coords.longitude, "GPS Location");
                }, () => alert('GPS Error'));
            }
        }

        async function fetchCity(name) {
            document.getElementById('loader').style.display='block';
            document.getElementById('mainContent').style.display='none';
            try {
                const g = await fetch(`https://geocoding-api.open-meteo.com/v1/search?name=${name}&count=1&language=en`).then(r=>r.json());
                if(!g.results) throw new Error("City not found");
                localStorage.setItem('proCityFix', g.results[0].name);
                fetchData(g.results[0].latitude, g.results[0].longitude, g.results[0].name);
            } catch(e) {
                alert("City not found"); document.getElementById('loader').style.display='none'; toggleSearch(true);
            }
        }

        async function fetchData(lat, lon, name) {
            const url = `https://api.open-meteo.com/v1/forecast?latitude=${lat}&longitude=${lon}&current=temperature_2m,weather_code,is_day,wind_speed_10m,relative_humidity_2m,apparent_temperature,pressure_msl&hourly=temperature_2m,weather_code&daily=temperature_2m_max,temperature_2m_min,weather_code&timezone=auto`;
            try {
                const d = await fetch(url).then(r=>r.json());
                updateUI(d, name);
            } catch(e) { console.error(e); }
        }

        function updateUI(data, name) {
            const c = data.current;
            const h = data.hourly;
            const daily = data.daily;
            const wc = weatherCodes[c.weather_code] || {l:'Unknown', i:'fa-cloud', type:'clear'};

            document.getElementById('uiCity').innerText = name;
            document.getElementById('uiDate').innerText = new Date().toLocaleDateString('en-US', {weekday:'long', month:'short', day:'numeric'});
            document.getElementById('uiTemp').innerText = Math.round(c.temperature_2m) + '°';
            document.getElementById('uiDesc').innerText = wc.l;
            document.getElementById('uiIcon').className = `fas ${wc.i} hero-icon`;
            document.getElementById('uiHigh').innerText = Math.round(daily.temperature_2m_max[0]);
            document.getElementById('uiLow').innerText = Math.round(daily.temperature_2m_min[0]);
            
            document.getElementById('uiWind').innerText = Math.round(c.wind_speed_10m);
            document.getElementById('uiHumid').innerText = c.relative_humidity_2m;
            document.getElementById('uiFeels').innerText = Math.round(c.apparent_temperature) + '°';
            document.getElementById('uiPres').innerText = Math.round(c.pressure_msl);

            // --- Theme Logic Fixed ---
            windSpeed = c.wind_speed_10m;
            isDayGlobal = c.is_day === 1; // مقداردهی متغیر سراسری
            
            initParticles(wc.type, wc.count || 0);

            const body = document.body;
            body.classList.remove('is-day', 'stormy'); // Reset

            if (c.is_day) {
                body.classList.add('is-day');
                // اگر هوا طوفانی یا خیلی بارانی بود، حتی در روز هم تم کمی تیره شود
                if (wc.type === 'rain' && wc.count > 100) {
                    body.classList.add('stormy');
                }
            }

            // Fill Hourly
            const hList = document.getElementById('hourlyList'); hList.innerHTML='';
            const now = new Date().getHours();
            for(let i=now; i<now+24; i++) {
                if(!h.time[i]) break;
                const div = document.createElement('div'); div.className='h-item';
                div.innerHTML = `<span>${i===now?'Now':new Date(h.time[i]).getHours()}</span><i class="fas ${(weatherCodes[h.weather_code[i]]||{}).i}" style="margin:5px 0"></i><span style="font-weight:600">${Math.round(h.temperature_2m[i])}°</span>`;
                hList.appendChild(div);
            }

            // Fill Daily
            const dList = document.getElementById('dailyList'); dList.innerHTML='';
            for(let i=0; i<7; i++) {
                const div = document.createElement('div'); div.className='day-row';
                const min = Math.round(daily.temperature_2m_min[i]);
                const max = Math.round(daily.temperature_2m_max[i]);
                const w = Math.max(10, ((max-min)/50)*100);
                const l = Math.max(0, ((min+10)/50)*100);
                div.innerHTML = `<span style="width:50px; font-weight:600">${i===0?'Today':new Date(daily.time[i]).toLocaleDateString('en-US',{weekday:'short'})}</span><i class="fas ${(weatherCodes[daily.weather_code[i]]||{}).i}" style="opacity:0.7"></i><div style="flex:1; display:flex; justify-content:flex-end; align-items:center;"><span style="width:25px; text-align:right; opacity:0.7">${min}°</span><div class="temp-bar-bg" style="margin:0 8px"><div class="temp-bar-fill" style="left:${l}%; width:${w}%"></div></div><span style="width:25px; font-weight:600">${max}°</span></div>`;
                dList.appendChild(div);
            }

            document.getElementById('loader').style.display='none';
            document.getElementById('mainContent').style.display='block';
        }
    </script>
</body>
</html>